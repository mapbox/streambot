#!/usr/bin/env bash

set -e

# Only argument is the directory to bundle
cd "$1"

mkdir -p "$1/build"
rm -rf "$1/build/package.json" "$1/build/node_modules"
cp "$1/package.json" "$1/build/package.json"
cd "$1/build/"

npm install --production \
  --target=0.10.38 \
  --target_platform=linux \
  --target_arch=x64 > /dev/null 2>&1

# Install streambot runtime dependencies
npm install --production aws-sdk dotenv fastlog > /dev/null 2>&1

# Make a zip archive
zipfile="$1/build/bundle.zip"
zip -r -q "$zipfile" . -x *.git* -x ./build* -x ./node_modules > /dev/null 2>&1
zip -r -q "$zipfile" "$1/build/node_modules" > /dev/null 2>&1

echo "$zipfile"
